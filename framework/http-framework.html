<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>HTTP handlers - Darklang roadmap</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../goals-of-dark-v2.html"><strong aria-hidden="true">2.</strong> Goals of Dark v2</a></li><li class="chapter-item expanded "><a href="../language/index.html"><strong aria-hidden="true">3.</strong> Language</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/built-in-types/index.html"><strong aria-hidden="true">3.1.</strong> Built in types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/built-in-types/ints.html"><strong aria-hidden="true">3.1.1.</strong> Int</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/strings.html"><strong aria-hidden="true">3.1.2.</strong> String</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/characters.html"><strong aria-hidden="true">3.1.3.</strong> Character</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/floats.html"><strong aria-hidden="true">3.1.4.</strong> Float</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/tuples.html"><strong aria-hidden="true">3.1.5.</strong> Tuple</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/bools.html"><strong aria-hidden="true">3.1.6.</strong> Bool</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/lists.html"><strong aria-hidden="true">3.1.7.</strong> List</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/dictionaries.html"><strong aria-hidden="true">3.1.8.</strong> Dictionary</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/options.html"><strong aria-hidden="true">3.1.9.</strong> Option</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/results.html"><strong aria-hidden="true">3.1.10.</strong> Result</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/set.html"><strong aria-hidden="true">3.1.11.</strong> Set</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/refs.html"><strong aria-hidden="true">3.1.12.</strong> Ref</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/regex.html"><strong aria-hidden="true">3.1.13.</strong> Regex</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/uuids.html"><strong aria-hidden="true">3.1.14.</strong> UUID</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/bytes.html"><strong aria-hidden="true">3.1.15.</strong> Bytes</a></li><li class="chapter-item expanded "><a href="../language/built-in-types/null.html"><strong aria-hidden="true">3.1.16.</strong> Null</a></li></ol></li><li class="chapter-item expanded "><a href="../language/control-flow/index.html"><strong aria-hidden="true">3.2.</strong> Control-flow</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/control-flow/concurrency-parallelism.html"><strong aria-hidden="true">3.2.1.</strong> Concurrency / parallelism</a></li><li class="chapter-item expanded "><a href="../language/control-flow/functions/index.html"><strong aria-hidden="true">3.2.2.</strong> Functions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/control-flow/functions/higher-order-functions.html"><strong aria-hidden="true">3.2.2.1.</strong> Higher-order functions</a></li><li class="chapter-item expanded "><a href="../language/control-flow/functions/binops.html"><strong aria-hidden="true">3.2.2.2.</strong> BinOps</a></li><li class="chapter-item expanded "><a href="../language/control-flow/functions/function-definitions.html"><strong aria-hidden="true">3.2.2.3.</strong> Function definitions</a></li><li class="chapter-item expanded "><a href="../language/control-flow/functions/function-calls.html"><strong aria-hidden="true">3.2.2.4.</strong> Function calls</a></li><li class="chapter-item expanded "><a href="../language/control-flow/functions/lambda.html"><strong aria-hidden="true">3.2.2.5.</strong> Lambda</a></li><li class="chapter-item expanded "><a href="../language/control-flow/functions/pipe.html"><strong aria-hidden="true">3.2.2.6.</strong> Pipe</a></li></ol></li><li class="chapter-item expanded "><a href="../language/control-flow/match.html"><strong aria-hidden="true">3.2.3.</strong> Match</a></li><li class="chapter-item expanded "><a href="../language/control-flow/let-statements.html"><strong aria-hidden="true">3.2.4.</strong> Let</a></li><li class="chapter-item expanded "><a href="../language/control-flow/if-statements.html"><strong aria-hidden="true">3.2.5.</strong> If</a></li></ol></li><li class="chapter-item expanded "><a href="../language/type-system/index.html"><strong aria-hidden="true">3.3.</strong> Type System</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/type-system/real-types.html"><strong aria-hidden="true">3.3.1.</strong> Real types</a></li><li class="chapter-item expanded "><a href="../language/type-system/type-checking.html"><strong aria-hidden="true">3.3.2.</strong> Type checking</a></li><li class="chapter-item expanded "><a href="../language/type-system/error-rail.html"><strong aria-hidden="true">3.3.3.</strong> Error Rail</a></li><li class="chapter-item expanded "><a href="../language/type-system/records.html"><strong aria-hidden="true">3.3.4.</strong> Records</a></li><li class="chapter-item expanded "><a href="../language/type-system/enums.html"><strong aria-hidden="true">3.3.5.</strong> Enums</a></li><li class="chapter-item expanded "><a href="../language/type-system/type-aliases.html"><strong aria-hidden="true">3.3.6.</strong> Type aliases</a></li><li class="chapter-item expanded "><a href="../language/type-system/traits.html"><strong aria-hidden="true">3.3.7.</strong> Traits</a></li></ol></li><li class="chapter-item expanded "><a href="../language/modules-and-namespacing.html"><strong aria-hidden="true">3.4.</strong> Modules and Namespacing</a></li><li class="chapter-item expanded "><a href="../language/json-handling.html"><strong aria-hidden="true">3.5.</strong> JSON handling</a></li><li class="chapter-item expanded "><a href="../language/language-versioning.html"><strong aria-hidden="true">3.6.</strong> Language versioning</a></li></ol></li><li class="chapter-item expanded "><a href="../editor/index.html"><strong aria-hidden="true">4.</strong> Editor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../editor/help-understanding.html"><strong aria-hidden="true">4.1.</strong> Help understanding</a></li><li class="chapter-item expanded "><a href="../editor/error-messages.html"><strong aria-hidden="true">4.2.</strong> Error messages</a></li><li class="chapter-item expanded "><a href="../editor/fluid-editor.html"><strong aria-hidden="true">4.3.</strong> Fluid editor</a></li><li class="chapter-item expanded "><a href="../editor/permissions-model.html"><strong aria-hidden="true">4.4.</strong> Permissions model</a></li><li class="chapter-item expanded "><a href="../editor/collaboration.html"><strong aria-hidden="true">4.5.</strong> Collaboration</a></li><li class="chapter-item expanded "><a href="../editor/ops.html"><strong aria-hidden="true">4.6.</strong> Ops</a></li><li class="chapter-item expanded "><a href="../editor/refactoring-commands.html"><strong aria-hidden="true">4.7.</strong> Refactoring commands</a></li><li class="chapter-item expanded "><a href="../editor/feature-flags.html"><strong aria-hidden="true">4.8.</strong> Feature flags</a></li><li class="chapter-item expanded "><a href="../editor/canvas.html"><strong aria-hidden="true">4.9.</strong> Canvas / code organization</a></li><li class="chapter-item expanded "><a href="../editor/profiler.html"><strong aria-hidden="true">4.10.</strong> Profiler</a></li><li class="chapter-item expanded "><a href="../editor/accounts.html"><strong aria-hidden="true">4.11.</strong> Accounts</a></li></ol></li><li class="chapter-item expanded "><a href="../framework/index.html"><strong aria-hidden="true">5.</strong> Framework</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../framework/error-tracking.html"><strong aria-hidden="true">5.1.</strong> Error Tracking</a></li><li class="chapter-item expanded "><a href="../framework/http-framework.html" class="active"><strong aria-hidden="true">5.2.</strong> HTTP handlers</a></li><li class="chapter-item expanded "><a href="../framework/graphql.html"><strong aria-hidden="true">5.3.</strong> GraphQL</a></li><li class="chapter-item expanded "><a href="../framework/datastores.html"><strong aria-hidden="true">5.4.</strong> Datastores</a></li><li class="chapter-item expanded "><a href="../framework/workers.html"><strong aria-hidden="true">5.5.</strong> Workers</a></li><li class="chapter-item expanded "><a href="../framework/cron-scheduled-jobs.html"><strong aria-hidden="true">5.6.</strong> Cron / scheduled jobs</a></li><li class="chapter-item expanded "><a href="../framework/analysis-and-traces.html"><strong aria-hidden="true">5.7.</strong> Traces / analysis / tests</a></li><li class="chapter-item expanded "><a href="../framework/domain-registration.html"><strong aria-hidden="true">5.8.</strong> Domain registration</a></li><li class="chapter-item expanded "><a href="../framework/static-assets.html"><strong aria-hidden="true">5.9.</strong> Static assets</a></li></ol></li><li class="chapter-item expanded "><a href="../infrastructure/index.html"><strong aria-hidden="true">6.</strong> Infrastructure</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../infrastructure/program-storage.html"><strong aria-hidden="true">6.1.</strong> Program storage</a></li></ol></li><li class="chapter-item expanded "><a href="../stdlib/index.html"><strong aria-hidden="true">7.</strong> Libraries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../stdlib/packages-and-stdlib.html"><strong aria-hidden="true">7.1.</strong> Package manager</a></li><li class="chapter-item expanded "><a href="../stdlib/httpclient-calls.html"><strong aria-hidden="true">7.2.</strong> HTTPClient calls</a></li><li class="chapter-item expanded "><a href="../stdlib/style-guide.html"><strong aria-hidden="true">7.3.</strong> Style guide</a></li><li class="chapter-item expanded "><a href="../stdlib/dark-v1-stdlib-1.html"><strong aria-hidden="true">7.4.</strong> Dark v1 stdlib</a></li><li class="chapter-item expanded "><a href="../stdlib/user-module.html"><strong aria-hidden="true">7.5.</strong> User module</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Darklang roadmap</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="http-handlers"><a class="header" href="#http-handlers">HTTP handlers</a></h1>
<h2 id="problem"><a class="header" href="#problem"><strong>Problem</strong></a></h2>
<p>Dark v1 had an implicit HTTP framework that was limited, opaque, and inflexible.</p>
<h3 id="problems-with-the-dark-v1"><a class="header" href="#problems-with-the-dark-v1"><strong>Problems with the Dark v1</strong></a></h3>
<ul>
<li>Users could not change how we processed a HTTP request
<ul>
<li>other encodings aren't supported and can't be added</li>
<li>you can't upload video or other &quot;bytes&quot; and things that aren't strings</li>
<li>Headers in HTTP should be allowed to be specified twice</li>
</ul>
</li>
<li>No input validation for any fields
<ul>
<li>you can validate manually which is really annoying</li>
<li>a JSON field is not type checked and could be any type</li>
</ul>
</li>
<li>empty request body (with just incompletes) was impossible to use</li>
<li>magic sending did not match the magic receiving</li>
<li>No way to specify a 404 or a 500 handler</li>
<li>No way to match arbitrary HTTP methods</li>
<li>Can't have a HEAD handler (the framework converts the request to a GET)</li>
<li>Should the standard 404 have a content-type header</li>
<li>if you return a string, it shouldn't have quotes, right? I mean it already is ct: text/plain</li>
<li>locking</li>
</ul>
<h2 id="solution-1-middleware"><a class="header" href="#solution-1-middleware"><strong>Solution 1: middleware</strong></a></h2>
<p>We want to support the creation of middleware stacks, collections of functions which transform HTTP requests and responses in a common way. These would allow:</p>
<ul>
<li>users to customize how input to HTTP handlers is created</li>
<li>separate handling for authenticated and unauthenticated routes</li>
<li>gradually adding support for partially implemented features (for example, v1 Dark can read latin1 and utf8, but not other encodings)</li>
<li>potentially graphql support could be a different middleware</li>
</ul>
<p>Middleware stacks are pretty common in other languages, Python (WSGI) and Clojure (Ring) being the two I'm most familiar with.</p>
<p>A middleware stack is simply a function wrapping another function.</p>
<p>If we have a function <code>handle(req : Request) -&gt; Response</code>, then a middleware handler is a function<code>middleware(innerFn : Request -&gt; Response) -&gt; (Request -&gt; Response)</code> (that is, it takes as an argument a function and returns a function, and both the parameter and returned functions take a request and return a result).</p>
<h3 id="whats-in-the-dark-v1-middleware"><a class="header" href="#whats-in-the-dark-v1-middleware"><strong>What's in the Dark v1 &quot;middleware&quot;?</strong></a></h3>
<ul>
<li>The Dark middleware is complicated and works poorly.</li>
</ul>
<p>Responses</p>
<ul>
<li>Anytime we infer a content-type, the content type is <code>text/plain; charset=utf-8</code> unless the value is an Object or List, in which case it is <code>application/json; charset=utf-8</code></li>
<li>If the response is a HttpResponse value, then we infer a content-type if none exists, then convert it to json or plain text using built-in functions</li>
<li>If the response in a HttpRedirect response, the value is ignored.</li>
<li>If the response is on the ErrorRail, a response of 404 is returned (**Note: **even if the ErrorRail is an Error)</li>
<li>If the response is a DError, a 500 is returned with an error message.</li>
<li>If the response is none of these, then we convert it to JSON and infer the header, using a code of 200. <strong>Note: this often gives a JSON string response with a text/plain header. this is unexpected and bad, and also the most common outcode. Instead it should content-negotiate</strong></li>
<li>Cors headers are then added, based on the CORS settings in the canvas</li>
<li>The value is then converted to Bytes, and returned to the caller</li>
<li>At no point does Dark do any content-negotiation</li>
</ul>
<p>Requests</p>
<ul>
<li>parsing path segments and inserting into the symtable</li>
<li>returning 418 for text/ping</li>
<li>creating a request object with formBody, jsonBody, cookies, url, body</li>
<li>automatically respond to HEAD for GET requests. Currently HEAD handlers can be created but will not be hit</li>
<li>automatically handling OPTIONS/CORS</li>
<li>using the dark favicon if none is provided</li>
<li>returning a blank sitemap or favicon</li>
<li>converting response to JSON string</li>
<li>converting response to other type?</li>
</ul>
<h3 id="desired-changes-in-dark-v2-http-middleware"><a class="header" href="#desired-changes-in-dark-v2-http-middleware">Desired changes in Dark v2 http middleware:</a></h3>
<ul>
<li>no special response for text/ping content types</li>
<li>all headers should be lowercase in requests</li>
<li>remove the x-forwarded-for, x-real-ip, x-forwarded-proto and x-forwarded headers
<ul>
<li>set the URL correctly</li>
<li>add an IP address to the uri object</li>
</ul>
</li>
<li>set the server to darklang</li>
<li>improve the cors middleware to make it seemless and safe
<ul>
<li>Add a type to allow users to specify their cors domain/null, etc</li>
<li>by default, return localhost:ANYTHING if that's provided</li>
<li>use good default headers</li>
</ul>
</li>
<li>remove the Connection header</li>
<li>support multipart form data</li>
<li>requests should support plain text</li>
<li>request bodies in GET should be allowed</li>
<li>accept-encoding should be responded too automatically</li>
</ul>
<h3 id="how-would-users-create-edit-and-delete-a-middleware"><a class="header" href="#how-would-users-create-edit-and-delete-a-middleware"><strong>How would users create, edit, and delete a middleware?</strong></a></h3>
<ul>
<li>middleware is just a function with a specific type signature</li>
<li>each step in the middleware would have to type check with the previous middleware</li>
<li>final middleware shows the type of request</li>
</ul>
<h3 id="where-would-users-specify-a-middleware-for-their-handler"><a class="header" href="#where-would-users-specify-a-middleware-for-their-handler"><strong>Where would users specify a middleware for their handler?</strong></a></h3>
<ul>
<li>the editor would allow the choice. HTTP uses the default stack (defined at handler creation time), and you can change the middleware stack directly, including changing to use the &quot;feature flag middleware&quot; stack</li>
</ul>
<h3 id="how-would-users-change-the-middleware-of-some-handler-or-set-of-handlers-eg-feature-flags"><a class="header" href="#how-would-users-change-the-middleware-of-some-handler-or-set-of-handlers-eg-feature-flags"><strong>How would users change the middleware of some handler or set of handlers (eg feature flags)?</strong></a></h3>
<ul>
<li>a feature flag middleware which chooses which of the two middleware stacks to process</li>
</ul>
<h2 id="implementation"><a class="header" href="#implementation"><strong>Implementation</strong></a></h2>
<p><strong>Middlewares</strong></p>
<p>Middlewares are typed functions that contribute a small, composable part of decoding a web request for the handler to use. Middlewares receive a request, and then based on the request, may choose to call the next middleware or simply return a response instead. As such, middlewares receive as parameters both the request so far, as well as the next middleware to call. They are responsible for calling the next middleware, possibly changing the request first and possible altering the response as well. This leads to middlewares having the following shape:</p>
<pre><code class="language-fsharp">let myMiddleware (arg : myMiddlewareArgType) next =
  fun (req : 'req) -&gt;
    let doSomethingToRequest req = { req with someExtraField = someFunction req }
    let doSomethingToResponse res = { res with someExtraField = someFunction res }
    let shortCircuitResponse = { status = 404, body = &quot;&quot;, headers = [] }
    if someCondition req
    then shortCircuitResponse
    else req
         |&gt; doSomethingToRequest
         |&gt; nextMiddleware
         |&gt; doSomethingToResponse
</code></pre>
<p>A middleware returns a function which takes a request. A middleware takes whatever arguments it needs, as well as the next middleware to call. As such, a middleware stack looks like this:</p>
<pre><code class="language-fsharp">let middleware =
  (\ctx -&gt; handler ctx) // shown like this for clarity
  |&gt; addQueryParams url
  |&gt; addHeaders headers
  |&gt; readVarsFromURL
  |&gt; addJsonBody headers body
  |&gt; addFormBody headers body
  |&gt; addCookies headers
  |&gt; processErrorRail
  |&gt; optionsHanderMiddleware
  |&gt; headHandlerMiddleware
  |&gt; textPingMiddleware
  |&gt; sitemapFaviconMiddleware middleware emptyRequest
</code></pre>
<p>Each middleware wraps the previous one, so the outermost middleware is last, and the handler comes first.</p>
<p>EmptyRequest is an empty record, and each middleware adds fields to it until the request has the shape required by the handler. It then returns a response, which can also have fields added to it by middleware wishing to send those fields to other middlewares.</p>
<p>As such, the types of the entire middleware have to add up to the type of the handler.</p>
<h2 id="editor-integration"><a class="header" href="#editor-integration">Editor integration</a></h2>
<p>How do we write out HTTP handlers in fluid, taking into account middleware?</p>
<pre><code class="language-fsharp">// idea: type http::GET, and it fills out the parameters path and response
http::GET
  path : ___
  response : ___
___

// then we fill in the values and we get
http::GET
  path : /hello/:name/:age
  name : String
  age : String
  response :

// these are defined by middleware such as:
fn get_body(raw_req :: HTTP::Request, user_obj,
</code></pre>
<p>Problem: we don't have anyway to dynamically create data in a type sensitive way. I want the handler to say &quot;there is this value _body_ that you now have available&quot;, how can I do that?</p>
<ul>
<li>Can the user_obj just be untyped and everything writes to it and we know it's type because the type checker figures it out?</li>
<li>add fields like in elm, start with an empty record and add fields to it. Type checks the whole way down</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../framework/error-tracking.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../framework/graphql.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../framework/error-tracking.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../framework/graphql.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
